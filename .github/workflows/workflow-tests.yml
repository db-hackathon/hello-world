name: Workflow Tests

# On-demand workflow tests for validating CI/CD attestation verification logic.
# Run this when making changes to workflow files or attestation logic.

on:
  workflow_dispatch:
    inputs:
      test_selection:
        description: 'Which tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - missing-sbom
          - missing-quality-gates
          - partial-quality-gates

env:
  # Google Artifact Registry (GAR) - primary container registry
  REGISTRY_GAR: europe-west1-docker.pkg.dev
  GAR_PROJECT_PRIMARY: extended-ascent-477308-m8
  GAR_REPO: idp-pov
  # WIF Configuration
  WORKLOAD_IDENTITY_PROVIDER: projects/785558430619/locations/global/workloadIdentityPools/github-2023/providers/github-2023

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  attestation-verification-test:
    name: Attestation Verification Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: idp-sa@${{ env.GAR_PROJECT_PRIMARY }}.iam.gserviceaccount.com

      - name: Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.REGISTRY_GAR }} --quiet

      # Test 1 & 2: Missing SBOM Detection
      - name: Create test image without SBOM
        if: inputs.test_selection == 'all' || inputs.test_selection == 'missing-sbom'
        run: |
          cat > /tmp/Dockerfile.test <<EOF
          FROM alpine:3.19
          LABEL org.opencontainers.image.revision="${{ github.sha }}"
          LABEL ci.run_id="${{ github.run_id }}"
          EOF
          docker build -t ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }} -f /tmp/Dockerfile.test /tmp
          docker push ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }}
          DIGEST=$(docker manifest inspect ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }} -v | jq -r '.Descriptor.digest')
          echo "DIGEST=$DIGEST" >> $GITHUB_ENV

      - name: Attest Build Provenance only (no SBOM)
        if: inputs.test_selection == 'all' || inputs.test_selection == 'missing-sbom'
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.DIGEST }}

      - name: Test missing SBOM is detected
        if: inputs.test_selection == 'all' || inputs.test_selection == 'missing-sbom'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          IMAGE="${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }}"

          echo "Test 1: Build Provenance should PASS..."
          if gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://slsa.dev/provenance/v1; then
            echo "✅ Build Provenance PASSED (expected)"
          else
            echo "ERROR: Build Provenance should have passed!"
            exit 1
          fi

          echo ""
          echo "Test 2: SBOM should FAIL (not attached)..."
          if gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://spdx.dev/Document 2>&1; then
            echo "ERROR: SBOM should have failed!"
            exit 1
          else
            echo "✅ SBOM correctly FAILED (expected)"
          fi

          echo ""
          echo "=========================================="
          echo "TEST 1 & 2 PASSED - Missing SBOM Detection"
          echo "=========================================="

      # Test 3: Missing Quality Gates Detection
      - name: Create test image with plain SBOM (no quality gates)
        if: inputs.test_selection == 'all' || inputs.test_selection == 'missing-quality-gates'
        run: |
          cat > /tmp/Dockerfile.plain <<EOF
          FROM alpine:3.19
          LABEL org.opencontainers.image.revision="${{ github.sha }}"
          LABEL ci.run_id="${{ github.run_id }}"
          LABEL ci.test_type="plain-sbom"
          EOF
          docker build -t ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }} -f /tmp/Dockerfile.plain /tmp
          docker push ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }}
          PLAIN_DIGEST=$(docker manifest inspect ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }} -v | jq -r '.Descriptor.digest')
          echo "PLAIN_DIGEST=$PLAIN_DIGEST" >> $GITHUB_ENV

          # Create a minimal SBOM without quality gate annotations
          cat > /tmp/plain-sbom.spdx.json <<'EOF'
          {
            "spdxVersion": "SPDX-2.3",
            "dataLicense": "CC0-1.0",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "attestation-test-plain",
            "documentNamespace": "https://spdx.org/spdxdocs/attestation-test-plain",
            "creationInfo": {
              "created": "2025-12-02T00:00:00Z",
              "creators": ["Tool: syft-test"]
            },
            "packages": [{
              "SPDXID": "SPDXRef-Package-alpine",
              "name": "alpine",
              "versionInfo": "3.19",
              "downloadLocation": "NOASSERTION"
            }]
          }
          EOF

      - name: Attest plain SBOM (without quality gates)
        if: inputs.test_selection == 'all' || inputs.test_selection == 'missing-quality-gates'
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.PLAIN_DIGEST }}
          sbom-path: /tmp/plain-sbom.spdx.json

      - name: Attest Build Provenance for plain image
        if: inputs.test_selection == 'all' || inputs.test_selection == 'missing-quality-gates'
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.PLAIN_DIGEST }}

      - name: Test missing quality gates are detected
        if: inputs.test_selection == 'all' || inputs.test_selection == 'missing-quality-gates'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          IMAGE="${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }}"

          echo "=========================================="
          echo "Test 3: SBOM exists but lacks quality gates"
          echo "=========================================="
          echo ""

          echo "Test 3a: Build Provenance should PASS..."
          if gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://slsa.dev/provenance/v1; then
            echo "✅ Build Provenance PASSED (expected)"
          else
            echo "ERROR: Build Provenance should have passed!"
            exit 1
          fi

          echo ""
          echo "Test 3b: SBOM attestation should PASS (it exists)..."
          SBOM_RESULT=$(gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://spdx.dev/Document \
               --format json 2>/dev/null || echo "[]")

          if [ "${SBOM_RESULT}" == "[]" ]; then
            echo "ERROR: SBOM should have passed!"
            exit 1
          else
            echo "✅ SBOM attestation PASSED (expected)"
          fi

          echo ""
          echo "Test 3c: Quality gate extraction should return EMPTY..."
          QUALITY_GATES=$(echo "${SBOM_RESULT}" | jq -r '
            .[0].verificationResult.statement.predicate.annotations[]? |
            select(.annotator == "Tool: baby-names-ci-pipeline") |
            .comment' 2>/dev/null || echo "")

          if [ -z "${QUALITY_GATES}" ]; then
            echo "✅ Quality gates correctly EMPTY (expected)"
            echo ""
            echo "This image would be BLOCKED in strict enforcement mode"
            echo "because quality gate hashes are missing from SBOM."
          else
            echo "ERROR: Quality gates should be empty!"
            echo "Found: ${QUALITY_GATES}"
            exit 1
          fi

          echo ""
          echo "Test 3d: Simulating strict enforcement mode..."
          STRICT_MODE=true
          if [ "$STRICT_MODE" = "true" ] && [ -z "${QUALITY_GATES}" ]; then
            echo "❌ DEPLOYMENT BLOCKED (strict mode)"
            echo ""
            echo "Reason: SBOM lacks quality gate annotations"
            echo "Required gates: lint, safety, coverage, trivy"
            echo ""
            echo "This demonstrates that strict enforcement would reject"
            echo "images built without proper quality gate verification."
          fi

          echo ""
          echo "=========================================="
          echo "TEST 3 PASSED - Missing Quality Gates Detection"
          echo ""
          echo "Verified supply chain enforcement:"
          echo "  ✅ SBOM exists → attestation passes"
          echo "  ✅ Missing quality gates → correctly detected"
          echo "  ✅ Strict mode → would block deployment"
          echo "=========================================="

      # Test 4: Partial Quality Gates Detection
      - name: Create test image with partial quality gates (missing lint)
        if: inputs.test_selection == 'all' || inputs.test_selection == 'partial-quality-gates'
        run: |
          cat > /tmp/Dockerfile.partial <<EOF
          FROM alpine:3.19
          LABEL org.opencontainers.image.revision="${{ github.sha }}"
          LABEL ci.run_id="${{ github.run_id }}"
          LABEL ci.test_type="partial-gates"
          EOF
          docker build -t ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:partial-gates-${{ github.run_id }} -f /tmp/Dockerfile.partial /tmp
          docker push ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:partial-gates-${{ github.run_id }}
          PARTIAL_DIGEST=$(docker manifest inspect ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:partial-gates-${{ github.run_id }} -v | jq -r '.Descriptor.digest')
          echo "PARTIAL_DIGEST=$PARTIAL_DIGEST" >> $GITHUB_ENV

          # Create SBOM with partial quality gates (missing lint)
          # This simulates a build that skipped linting
          cat > /tmp/partial-sbom.spdx.json <<'SBOMEOF'
          {
            "spdxVersion": "SPDX-2.3",
            "dataLicense": "CC0-1.0",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "attestation-test-partial",
            "documentNamespace": "https://spdx.org/spdxdocs/attestation-test-partial",
            "creationInfo": {
              "created": "2025-12-02T00:00:00Z",
              "creators": ["Tool: syft-test"]
            },
            "packages": [{
              "SPDXID": "SPDXRef-Package-alpine",
              "name": "alpine",
              "versionInfo": "3.19",
              "downloadLocation": "NOASSERTION"
            }],
            "annotations": [{
              "annotationDate": "2025-12-02T00:00:00Z",
              "annotationType": "OTHER",
              "annotator": "Tool: baby-names-ci-pipeline",
              "comment": "quality_gates={\"safety\": \"sha256:abc123\", \"coverage\": \"sha256:def456\", \"trivy\": \"sha256:ghi789\"};git_sha=test123;run_id=99999"
            }]
          }
          SBOMEOF

      - name: Attest partial SBOM (missing lint gate)
        if: inputs.test_selection == 'all' || inputs.test_selection == 'partial-quality-gates'
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.PARTIAL_DIGEST }}
          sbom-path: /tmp/partial-sbom.spdx.json

      - name: Attest Build Provenance for partial image
        if: inputs.test_selection == 'all' || inputs.test_selection == 'partial-quality-gates'
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.PARTIAL_DIGEST }}

      - name: Test partial quality gates are detected (missing lint)
        if: inputs.test_selection == 'all' || inputs.test_selection == 'partial-quality-gates'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          IMAGE="${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:partial-gates-${{ github.run_id }}"

          echo "=========================================="
          echo "Test 4: SBOM with partial quality gates"
          echo "=========================================="
          echo ""
          echo "This test verifies that images with SOME but not ALL"
          echo "required quality gates are correctly rejected in strict mode."
          echo ""

          echo "Test 4a: Build Provenance should PASS..."
          if gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://slsa.dev/provenance/v1; then
            echo "✅ Build Provenance PASSED (expected)"
          else
            echo "ERROR: Build Provenance should have passed!"
            exit 1
          fi

          echo ""
          echo "Test 4b: SBOM attestation should PASS..."
          SBOM_RESULT=$(gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://spdx.dev/Document \
               --format json 2>/dev/null || echo "[]")

          if [ "${SBOM_RESULT}" == "[]" ]; then
            echo "ERROR: SBOM should have passed!"
            exit 1
          else
            echo "✅ SBOM attestation PASSED (expected)"
          fi

          echo ""
          echo "Test 4c: Extract quality gates from SBOM..."
          QUALITY_GATES=$(echo "${SBOM_RESULT}" | jq -r '
            .[0].verificationResult.statement.predicate.annotations[]? |
            select(.annotator == "Tool: baby-names-ci-pipeline") |
            .comment' 2>/dev/null || echo "")

          if [ -n "${QUALITY_GATES}" ]; then
            echo "✅ Quality gates found: ${QUALITY_GATES}"
          else
            echo "ERROR: Quality gates should be present!"
            exit 1
          fi

          echo ""
          echo "Test 4d: Validate required gates (simulating CD strict mode)..."

          # Extract quality_gates JSON from the comment string
          QG_JSON=$(echo "${QUALITY_GATES}" | grep -oP 'quality_gates=\K\{[^}]+\}' || echo "{}")
          echo "Extracted gates JSON: ${QG_JSON}"

          # Check for all required gates for backend/frontend
          REQUIRED_GATES="lint safety coverage trivy"
          MISSING_GATES=""

          for gate in ${REQUIRED_GATES}; do
            if echo "${QG_JSON}" | jq -e ".${gate}" > /dev/null 2>&1; then
              echo "  ✓ ${gate}: present"
            else
              echo "  ✗ ${gate}: MISSING"
              MISSING_GATES="${MISSING_GATES} ${gate}"
            fi
          done

          echo ""
          if [ -n "${MISSING_GATES}" ]; then
            echo "✅ Missing gates correctly detected:${MISSING_GATES}"
            echo ""
            echo "In strict mode, this image would be REJECTED because"
            echo "it lacks the 'lint' quality gate hash in the SBOM."
          else
            echo "ERROR: Should have detected missing 'lint' gate!"
            exit 1
          fi

          echo ""
          echo "=========================================="
          echo "TEST 4 PASSED - Partial Quality Gates Detection"
          echo ""
          echo "Verified:"
          echo "  ✅ SBOM with partial gates → attestation passes"
          echo "  ✅ Missing 'lint' gate → correctly detected"
          echo "  ✅ Strict mode → would block deployment"
          echo "=========================================="

      - name: Cleanup test images
        if: always()
        run: |
          # Only cleanup images that were created based on test selection
          if [ "${{ inputs.test_selection }}" == "all" ] || [ "${{ inputs.test_selection }}" == "missing-sbom" ]; then
            gcloud artifacts docker images delete \
              ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }} \
              --quiet --delete-tags || true
          fi
          if [ "${{ inputs.test_selection }}" == "all" ] || [ "${{ inputs.test_selection }}" == "missing-quality-gates" ]; then
            gcloud artifacts docker images delete \
              ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }} \
              --quiet --delete-tags || true
          fi
          if [ "${{ inputs.test_selection }}" == "all" ] || [ "${{ inputs.test_selection }}" == "partial-quality-gates" ]; then
            gcloud artifacts docker images delete \
              ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:partial-gates-${{ github.run_id }} \
              --quiet --delete-tags || true
          fi

      - name: Test Summary
        run: |
          echo "## Workflow Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests run: **${{ inputs.test_selection }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Description | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.test_selection }}" == "all" ] || [ "${{ inputs.test_selection }}" == "missing-sbom" ]; then
            echo "| Test 1-2 | Missing SBOM Detection | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.test_selection }}" == "all" ] || [ "${{ inputs.test_selection }}" == "missing-quality-gates" ]; then
            echo "| Test 3 | Missing Quality Gates Detection | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.test_selection }}" == "all" ] || [ "${{ inputs.test_selection }}" == "partial-quality-gates" ]; then
            echo "| Test 4 | Partial Quality Gates Detection | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          fi
