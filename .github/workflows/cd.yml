name: CD

on:
  # Trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

  # Manual trigger with commit SHA selection
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to deploy (uses images tagged main-{sha})'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Dry-run mode: validate workflow without deploying'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/baby-names-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/baby-names-frontend

jobs:
  # Resolve which SHA to deploy and validate images
  resolve-sha:
    name: Resolve Deployment SHA
    runs-on: ubuntu-latest
    # Skip if workflow_run triggered by failed CI
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: read
      packages: read
    outputs:
      deploy_sha: ${{ steps.resolve.outputs.sha }}
      short_sha: ${{ steps.resolve.outputs.short_sha }}
      is_dry_run: ${{ steps.resolve.outputs.is_dry_run }}
      environment: ${{ steps.resolve.outputs.environment }}
    steps:
      - name: Resolve deployment SHA
        id: resolve
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHA="${{ github.event.inputs.commit_sha }}"
            IS_DRY_RUN="${{ github.event.inputs.dry_run }}"
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            # workflow_run trigger - use the SHA from the CI workflow
            SHA="${{ github.event.workflow_run.head_sha }}"
            IS_DRY_RUN="false"
            ENVIRONMENT="staging"
          fi

          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHA:0:7}" >> $GITHUB_OUTPUT
          echo "is_dry_run=${IS_DRY_RUN}" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT

          echo "=========================================="
          echo "Deployment Configuration"
          echo "=========================================="
          echo "Commit SHA: ${SHA}"
          echo "Short SHA: ${SHA:0:7}"
          echo "Environment: ${ENVIRONMENT}"
          echo "Dry Run: ${IS_DRY_RUN}"
          echo "Trigger: ${{ github.event_name }}"
          echo "=========================================="

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate images exist in registry
        env:
          DEPLOY_SHA: ${{ steps.resolve.outputs.sha }}
        run: |
          echo "Validating container images exist..."

          BACKEND_IMAGE="ghcr.io/${{ github.repository }}/baby-names-backend:main-${DEPLOY_SHA}"
          FRONTEND_IMAGE="ghcr.io/${{ github.repository }}/baby-names-frontend:main-${DEPLOY_SHA}"
          MIGRATION_IMAGE="ghcr.io/${{ github.repository }}/baby-names-db-migration:main-${DEPLOY_SHA}"

          echo "Checking backend: ${BACKEND_IMAGE}"
          docker manifest inspect "${BACKEND_IMAGE}" > /dev/null
          echo "✅ Backend image exists"

          echo "Checking frontend: ${FRONTEND_IMAGE}"
          docker manifest inspect "${FRONTEND_IMAGE}" > /dev/null
          echo "✅ Frontend image exists"

          echo "Checking migration: ${MIGRATION_IMAGE}"
          docker manifest inspect "${MIGRATION_IMAGE}" > /dev/null
          echo "✅ Migration image exists"

          echo ""
          echo "=========================================="
          echo "All images validated successfully!"
          echo "=========================================="

      - name: Dry-run summary
        if: steps.resolve.outputs.is_dry_run == 'true'
        run: |
          echo "=========================================="
          echo "DRY-RUN MODE - Deployment Plan"
          echo "=========================================="
          echo ""
          echo "Would deploy the following:"
          echo "  Commit: ${{ steps.resolve.outputs.sha }}"
          echo "  Environment: ${{ steps.resolve.outputs.environment }}"
          echo ""
          echo "Images:"
          echo "  Backend:   ghcr.io/${{ github.repository }}/baby-names-backend:main-${{ steps.resolve.outputs.sha }}"
          echo "  Frontend:  ghcr.io/${{ github.repository }}/baby-names-frontend:main-${{ steps.resolve.outputs.sha }}"
          echo "  Migration: ghcr.io/${{ github.repository }}/baby-names-db-migration:main-${{ steps.resolve.outputs.sha }}"
          echo ""
          echo "Validation: ✅ All images exist in registry"
          echo ""
          echo "No actual deployment will be performed."
          echo "=========================================="

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: resolve-sha
    # Run for: workflow_run (auto) OR workflow_dispatch with staging selected
    # Skip for: dry-run mode OR production selected
    if: >
      needs.resolve-sha.outputs.is_dry_run != 'true' &&
      (github.event_name == 'workflow_run' ||
       (github.event_name == 'workflow_dispatch' && needs.resolve-sha.outputs.environment == 'staging'))
    environment:
      name: staging
      url: http://gke-df4e635bf6a042d9a06ccadd5f88beab6860-254825841253.europe-west1.gke.goog
    permissions:
      contents: read
      packages: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Direct WIF)
        uses: google-github-actions/auth@v3
        with:
          project_id: extended-ascent-477308-m8
          workload_identity_provider: projects/785558430619/locations/global/workloadIdentityPools/github-2023/providers/github-2023

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials hellow-world-manual \
            --region=europe-west1 \
            --project=extended-ascent-477308-m8

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy with Helm
        working-directory: examples/baby-names/helm/baby-names
        env:
          DEPLOY_SHA: ${{ needs.resolve-sha.outputs.deploy_sha }}
        run: |
          helm upgrade --install baby-names . \
            --namespace baby-names-staging \
            --create-namespace \
            --values values-staging.yaml \
            --set backend.image.tag=main-${DEPLOY_SHA} \
            --set frontend.image.tag=main-${DEPLOY_SHA} \
            --set migration.image.tag=main-${DEPLOY_SHA} \
            --wait \
            --timeout 15m

      - name: Verify deployment
        run: |
          echo "=== Verifying deployment rollout ==="

          # Wait for deployments to be ready (with timeout)
          echo "Waiting for backend deployment..."
          kubectl rollout status deployment/baby-names-backend -n baby-names-staging --timeout=5m

          echo "Waiting for frontend deployment..."
          kubectl rollout status deployment/baby-names-frontend -n baby-names-staging --timeout=5m

          # Verify all pods are running
          echo "=== Pod Status ==="
          kubectl get pods -n baby-names-staging

          # Check that no pods are in error state
          FAILED_PODS=$(kubectl get pods -n baby-names-staging --field-selector=status.phase!=Running,status.phase!=Succeeded -o name 2>/dev/null | wc -l)
          if [ "$FAILED_PODS" -gt 0 ]; then
            echo "ERROR: Found $FAILED_PODS pods not in Running/Succeeded state"
            kubectl get pods -n baby-names-staging --field-selector=status.phase!=Running,status.phase!=Succeeded
            exit 1
          fi

          echo "=== Service Status ==="
          kubectl get services -n baby-names-staging

          echo "=== Ingress Status ==="
          kubectl get ingress -n baby-names-staging

          # Wait for ingress IP (with timeout)
          echo "Waiting for ingress IP assignment..."
          for i in {1..30}; do
            INGRESS_IP=$(kubectl get ingress baby-names -n baby-names-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
            if [ -n "$INGRESS_IP" ]; then
              echo "Ingress IP assigned: $INGRESS_IP"
              break
            fi
            echo "Attempt $i: No ingress IP yet, waiting 10s..."
            sleep 10
          done

          if [ -z "$INGRESS_IP" ]; then
            echo "WARNING: Ingress IP not assigned within timeout (smoke tests may fail)"
          fi

          echo "=== Deployment verification complete ==="

      - name: Record deployment
        env:
          DEPLOY_SHA: ${{ needs.resolve-sha.outputs.deploy_sha }}
        run: |
          echo "Deployment to staging completed at $(date)"
          echo "Git SHA: ${DEPLOY_SHA}"
          echo "Actor: ${{ github.actor }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Backend image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:main-${DEPLOY_SHA}"
          echo "Frontend image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:main-${DEPLOY_SHA}"

  smoke-tests-staging:
    name: Smoke Tests (Staging)
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install pytest requests

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be fully ready..."
          sleep 60

      - name: Test frontend health endpoint
        env:
          FRONTEND_URL: http://gke-df4e635bf6a042d9a06ccadd5f88beab6860-254825841253.europe-west1.gke.goog
        run: |
          echo "Testing frontend health at $FRONTEND_URL/health"
          curl --retry 10 --retry-delay 10 --retry-connrefused --fail "$FRONTEND_URL/health"

      - name: Test backend health endpoint (via frontend proxy)
        env:
          FRONTEND_URL: http://gke-df4e635bf6a042d9a06ccadd5f88beab6860-254825841253.europe-west1.gke.goog
        run: |
          echo "Testing backend health via $FRONTEND_URL/api/health"
          curl --retry 10 --retry-delay 10 --retry-connrefused --fail "$FRONTEND_URL/api/health"

      - name: Test critical user path
        env:
          FRONTEND_URL: http://gke-df4e635bf6a042d9a06ccadd5f88beab6860-254825841253.europe-west1.gke.goog
        run: |
          echo "Testing name lookup for 'Noah'"
          RESPONSE=$(curl --fail "$FRONTEND_URL/api/names/Noah")
          echo "Response: $RESPONSE"
          echo "$RESPONSE" | grep -q "rank"

      - name: Smoke tests summary
        run: |
          echo "=========================================="
          echo "SMOKE TESTS COMPLETED SUCCESSFULLY"
          echo "=========================================="
          echo ""
          echo "All critical paths verified:"
          echo "  ✓ Frontend health endpoint responding"
          echo "  ✓ Backend health endpoint responding"
          echo "  ✓ Database connectivity verified"
          echo "  ✓ Name lookup functionality working"
          echo ""
          echo "Staging deployment is healthy and ready!"
          echo "=========================================="

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [resolve-sha, smoke-tests-staging]
    # Only manual production deployments
    # Skip for: dry-run mode
    # Uses always() to run even when staging is skipped (direct production deploy)
    if: >
      always() &&
      needs.resolve-sha.result == 'success' &&
      needs.resolve-sha.outputs.is_dry_run != 'true' &&
      github.event_name == 'workflow_dispatch' &&
      needs.resolve-sha.outputs.environment == 'production' &&
      (needs.smoke-tests-staging.result == 'success' || needs.smoke-tests-staging.result == 'skipped')
    environment:
      name: production
      url: https://baby-names.example.com
    permissions:
      contents: read
      packages: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull images
        env:
          DEPLOY_SHA: ${{ needs.resolve-sha.outputs.deploy_sha }}
        run: |
          echo "Pulling backend image..."
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:main-${DEPLOY_SHA}"
          echo "Pulling frontend image..."
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:main-${DEPLOY_SHA}"

      - name: Deploy to Production Kubernetes (Stubbed)
        env:
          DEPLOY_SHA: ${{ needs.resolve-sha.outputs.deploy_sha }}
        run: |
          echo "=========================================="
          echo "PRODUCTION DEPLOYMENT - CURRENTLY STUBBED"
          echo "=========================================="
          echo ""
          echo "This step would:"
          echo "  1. Configure kubectl with production cluster credentials"
          echo "  2. Apply Kubernetes manifests with production configs"
          echo "  3. Perform blue-green or canary deployment"
          echo "  4. Update image tags to: main-${DEPLOY_SHA}"
          echo "  5. Gradual traffic shift to new version"
          echo "  6. Monitor error rates and latency"
          echo "  7. Automatic rollback on failure"
          echo ""
          echo "Target cluster: production-k8s-cluster"
          echo "Namespace: baby-names-prod"
          echo "Backend image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:main-${DEPLOY_SHA}"
          echo "Frontend image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:main-${DEPLOY_SHA}"
          echo ""
          echo "Production features:"
          echo "  - Multi-zone deployment for high availability"
          echo "  - Production-grade PostgreSQL with read replicas"
          echo "  - CDN for static assets"
          echo "  - WAF and DDoS protection"
          echo "  - Comprehensive monitoring and alerting"
          echo ""
          echo "=========================================="

      - name: Record production deployment
        env:
          DEPLOY_SHA: ${{ needs.resolve-sha.outputs.deploy_sha }}
        run: |
          echo "Production deployment completed at $(date)"
          echo "Git SHA: ${DEPLOY_SHA}"
          echo "Actor: ${{ github.actor }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Deployment requires manual approval via GitHub Environments"

  smoke-tests-production:
    name: Smoke Tests (Production)
    runs-on: ubuntu-latest
    needs: deploy-production
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install pytest requests

      - name: Run smoke tests (Stubbed)
        env:
          BACKEND_URL: https://api.baby-names.example.com
          FRONTEND_URL: https://baby-names.example.com
        run: |
          echo "=========================================="
          echo "PRODUCTION SMOKE TESTS - CURRENTLY STUBBED"
          echo "=========================================="
          echo ""
          echo "This step would run:"
          echo "  pytest tests/smoke/ -v"
          echo ""
          echo "Against production endpoints:"
          echo "  Backend: $BACKEND_URL"
          echo "  Frontend: $FRONTEND_URL"
          echo ""
          echo "Tests would verify:"
          echo "  ✓ Services are responding"
          echo "  ✓ Health endpoints return 200"
          echo "  ✓ Database connectivity"
          echo "  ✓ Critical user path (search for name)"
          echo "  ✓ Top names are present in database"
          echo "  ✓ SSL certificates valid"
          echo "  ✓ Response times within SLO"
          echo ""
          echo "All production smoke tests passed (simulated)"
          echo "=========================================="

      - name: Notify deployment success
        run: |
          echo "Production deployment verified successfully"
          echo "Application is live at https://baby-names.example.com"
