name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # Google Artifact Registry (GAR) - primary container registry
  REGISTRY_GAR: europe-west1-docker.pkg.dev
  GAR_PROJECT_PRIMARY: extended-ascent-477308-m8
  GAR_PROJECT_SECONDARY: geometric-rock-477308-e2
  GAR_REPO: idp-pov
  IMAGE_NAME_PREFIX_GAR: baby-names
  # WIF Configuration
  WORKLOAD_IDENTITY_PROVIDER: projects/785558430619/locations/global/workloadIdentityPools/github-2023/providers/github-2023

permissions:
  contents: read
  packages: write
  id-token: write        # Required for attestations
  attestations: write    # Required for attestations
  security-events: write # For Trivy SARIF uploads

jobs:
  ##
  ## PHASE A - Sequential, Fail-Fast Quality Gates
  ##

  format-and-lint:
    name: Format & Lint Check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        component: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Check code formatting
        working-directory: examples/baby-names/${{ matrix.component }}
        run: make format-check

      - name: Run linting
        working-directory: examples/baby-names/${{ matrix.component }}
        run: make lint

      - name: Generate lint report for attestation
        working-directory: examples/baby-names/${{ matrix.component }}
        if: always()
        run: |
          pip install -q ruff==0.8.4
          ruff check . --output-format=json > lint-results.json || true

      - name: Upload lint results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: lint-results-${{ matrix.component }}
          path: examples/baby-names/${{ matrix.component }}/lint-results.json
          retention-days: 30

      - name: Attest lint results
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        if: always()
        with:
          subject-path: examples/baby-names/${{ matrix.component }}/lint-results.json

  dependency-security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    needs: format-and-lint
    strategy:
      fail-fast: true
      matrix:
        component: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Run safety scan
        working-directory: examples/baby-names/${{ matrix.component }}
        run: make security-check

      - name: Generate safety report for attestation
        working-directory: examples/baby-names/${{ matrix.component }}
        if: always()
        run: |
          pip install -q -r requirements.txt
          safety check --json > safety-report.json || true

      - name: Upload safety report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: safety-report-${{ matrix.component }}
          path: examples/baby-names/${{ matrix.component }}/safety-report.json
          retention-days: 30

      - name: Attest safety report
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        if: always()
        with:
          subject-path: examples/baby-names/${{ matrix.component }}/safety-report.json

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: dependency-security
    strategy:
      fail-fast: true
      matrix:
        component: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Run unit tests
        working-directory: examples/baby-names/${{ matrix.component }}
        run: make test

      - name: Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-${{ matrix.component }}
          path: examples/baby-names/${{ matrix.component }}/coverage.xml
          retention-days: 30

      - name: Attest coverage report
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-path: examples/baby-names/${{ matrix.component }}/coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        continue-on-error: true
        with:
          files: examples/baby-names/${{ matrix.component }}/coverage.xml
          flags: ${{ matrix.component }}
          name: ${{ matrix.component }}-coverage
          fail_ci_if_error: false

  ##
  ## PHASE B - Parallel Build, Scan, Attest, Push
  ##

  build-scan-attest:
    name: Build, Scan & Attest (${{ matrix.component }})
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      fail-fast: true
      matrix:
        component: [backend, frontend, db-migration]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download quality gate artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: quality-gates/

      - name: Set component directory
        id: set-dir
        run: |
          if [ "${{ matrix.component }}" == "db-migration" ]; then
            echo "dir=database" >> $GITHUB_OUTPUT
          else
            echo "dir=${{ matrix.component }}" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f # v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: idp-sa@${{ env.GAR_PROJECT_PRIMARY }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f # v2

      - name: Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.REGISTRY_GAR }} --quiet

      - name: Extract metadata for GAR (primary)
        id: meta-gar-primary
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME_PREFIX_GAR }}-${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=main-,enable=${{ github.ref == 'refs/heads/main' }}
            type=semver,pattern={{version}}

      - name: Extract metadata for GAR (secondary)
        id: meta-gar-secondary
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_SECONDARY }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME_PREFIX_GAR }}-${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=main-,enable=${{ github.ref == 'refs/heads/main' }}
            type=semver,pattern={{version}}

      - name: Build container image
        id: build
        working-directory: examples/baby-names/${{ steps.set-dir.outputs.dir }}
        run: make build

      - name: Tag image for GAR registries
        run: |
          LOCAL_IMAGE="ghcr.io/db-hackathon/baby-names-${{ matrix.component }}:local"

          # Tag for GAR primary
          echo "Tagging for GAR primary..."
          echo "${{ steps.meta-gar-primary.outputs.tags }}" | while read -r tag; do
            echo "  Tagging: $tag"
            docker tag $LOCAL_IMAGE "$tag"
          done

          # Tag for GAR secondary
          echo "Tagging for GAR secondary..."
          echo "${{ steps.meta-gar-secondary.outputs.tags }}" | while read -r tag; do
            echo "  Tagging: $tag"
            docker tag $LOCAL_IMAGE "$tag"
          done

          # Store first GAR primary tag for attestation subject
          REGISTRY_TAG=$(echo "${{ steps.meta-gar-primary.outputs.tags }}" | head -n1)
          echo "REGISTRY_TAG=$REGISTRY_TAG" >> $GITHUB_ENV

          # Store all tags for push step
          echo "ALL_TAGS_GAR_PRIMARY<<EOF" >> $GITHUB_ENV
          echo "${{ steps.meta-gar-primary.outputs.tags }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "ALL_TAGS_GAR_SECONDARY<<EOF" >> $GITHUB_ENV
          echo "${{ steps.meta-gar-secondary.outputs.tags }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # CRITICAL: Push to GAR primary FIRST so we can get the manifest digest for attestation
      - name: Push to GAR primary (for attestation)
        if: github.event_name != 'pull_request'
        run: |
          echo "=== Pushing to GAR primary (${{ env.GAR_PROJECT_PRIMARY }}) ==="
          echo "${{ env.ALL_TAGS_GAR_PRIMARY }}" | while read -r tag; do
            echo "Pushing: $tag"
            docker push "$tag"
          done

      - name: Get manifest digest from registry
        id: digest
        if: github.event_name != 'pull_request'
        run: |
          # Get manifest digest from registry AFTER push (not local config digest)
          # This is required for attestation verification to work correctly
          DIGEST=$(docker manifest inspect ${{ env.REGISTRY_TAG }} -v | jq -r '.Descriptor.digest')
          echo "Manifest digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@fbfd9c6c189226748411491745178e0c2017392d # v0

      - name: Generate SBOM
        working-directory: examples/baby-names/${{ steps.set-dir.outputs.dir }}
        run: make generate-sbom

      - name: Extend SBOM with quality gate hashes
        working-directory: examples/baby-names/${{ steps.set-dir.outputs.dir }}
        run: |
          SBOM_FILE="${{ matrix.component }}-sbom.spdx.json"

          # Compute hashes of quality gate artifacts
          # For backend/frontend components, include their specific artifacts
          # For db-migration, include only trivy scan

          if [ "${{ matrix.component }}" == "db-migration" ]; then
            TRIVY_HASH=$(sha256sum ${GITHUB_WORKSPACE}/quality-gates/trivy-results-db-migration/db-migration-trivy.json | cut -d' ' -f1)
            QUALITY_GATES_JSON="{\"trivy\": \"sha256:${TRIVY_HASH}\"}"
          else
            COMPONENT="${{ matrix.component }}"
            LINT_HASH=$(sha256sum ${GITHUB_WORKSPACE}/quality-gates/lint-results-${COMPONENT}/lint-results.json | cut -d' ' -f1)
            SAFETY_HASH=$(sha256sum ${GITHUB_WORKSPACE}/quality-gates/safety-report-${COMPONENT}/safety-report.json | cut -d' ' -f1)
            COVERAGE_HASH=$(sha256sum ${GITHUB_WORKSPACE}/quality-gates/coverage-${COMPONENT}/coverage.xml | cut -d' ' -f1)
            TRIVY_HASH=$(sha256sum ${GITHUB_WORKSPACE}/quality-gates/trivy-results-${COMPONENT}/${COMPONENT}-trivy.json | cut -d' ' -f1)
            QUALITY_GATES_JSON="{\"lint\": \"sha256:${LINT_HASH}\", \"safety\": \"sha256:${SAFETY_HASH}\", \"coverage\": \"sha256:${COVERAGE_HASH}\", \"trivy\": \"sha256:${TRIVY_HASH}\"}"
          fi

          # Add annotation to SBOM using jq
          jq --arg qg "${QUALITY_GATES_JSON}" \
             --arg git_sha "${{ github.sha }}" \
             --arg run_id "${{ github.run_id }}" \
             --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '.annotations = (.annotations // []) + [{
               "annotationDate": $timestamp,
               "annotationType": "OTHER",
               "annotator": "Tool: baby-names-ci-pipeline",
               "comment": ("quality_gates=" + $qg + ";git_sha=" + $git_sha + ";run_id=" + $run_id)
             }]' \
             "${SBOM_FILE}" > "${SBOM_FILE}.tmp" && mv "${SBOM_FILE}.tmp" "${SBOM_FILE}"

          echo "Enhanced SBOM with quality gate hashes:"
          jq '.annotations' "${SBOM_FILE}"

      # Note: exit-code 0 matches original Makefile behavior which allowed
      # upstream image vulnerabilities (e.g., Flyway JRE base) to not fail CI.
      # The scan results are still recorded and attested for visibility.
      - name: Scan container image with Trivy
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: '${{ env.REGISTRY_TAG }}'
          format: 'json'
          output: 'examples/baby-names/${{ steps.set-dir.outputs.dir }}/${{ matrix.component }}-trivy.json'
          severity: 'CRITICAL'
          exit-code: '0'

      - name: Upload Trivy results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: trivy-results-${{ matrix.component }}
          path: examples/baby-names/${{ steps.set-dir.outputs.dir }}/${{ matrix.component }}-trivy.json
          retention-days: 30

      - name: Attest Trivy scan results
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        if: always()
        with:
          subject-path: examples/baby-names/${{ steps.set-dir.outputs.dir }}/${{ matrix.component }}-trivy.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sbom-${{ matrix.component }}
          path: examples/baby-names/${{ steps.set-dir.outputs.dir }}/${{ matrix.component }}-sbom.spdx.json
          retention-days: 30

      - name: Attest SBOM
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
        if: github.event_name != 'pull_request'
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME_PREFIX_GAR }}-${{ matrix.component }}
          subject-digest: ${{ steps.digest.outputs.digest }}
          sbom-path: examples/baby-names/${{ steps.set-dir.outputs.dir }}/${{ matrix.component }}-sbom.spdx.json
          push-to-registry: false

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        if: github.event_name != 'pull_request'
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME_PREFIX_GAR }}-${{ matrix.component }}
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

      # GAR primary already pushed above (before attestation)
      # Now push to GAR secondary for cross-region redundancy
      - name: Push to GAR secondary
        if: github.event_name != 'pull_request'
        run: |
          echo "=== Pushing to GAR secondary (${{ env.GAR_PROJECT_SECONDARY }}) ==="
          echo "${{ env.ALL_TAGS_GAR_SECONDARY }}" | while read -r tag; do
            echo "Pushing: $tag"
            docker push "$tag"
          done
          echo "=== All pushes complete ==="

      - name: Add container details to job summary
        if: github.event_name != 'pull_request'
        run: |
          DIGEST_SHORT=$(echo "${{ steps.digest.outputs.digest }}" | cut -c8-26)
          GAR_PRIMARY_TAG=$(echo "${{ steps.meta-gar-primary.outputs.tags }}" | head -n1)
          GAR_SECONDARY_TAG=$(echo "${{ steps.meta-gar-secondary.outputs.tags }}" | head -n1)
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### Container: \`${{ matrix.component }}\`

          | Property | Value |
          |----------|-------|
          | **GAR Primary** | \`${GAR_PRIMARY_TAG}\` |
          | **GAR Secondary** | \`${GAR_SECONDARY_TAG}\` |
          | **Manifest Digest** | \`${DIGEST_SHORT}...\` |
          | **Full Digest** | \`${{ steps.digest.outputs.digest }}\` |

          **Attestations**: SBOM and Build Provenance linked to GAR primary image using manifest digest.

          ---
          EOF

  ##
  ## Attestation Verification Test
  ##

  attestation-verification-test:
    name: Attestation Verification Test
    runs-on: ubuntu-latest
    needs: build-scan-attest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f # v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: idp-sa@${{ env.GAR_PROJECT_PRIMARY }}.iam.gserviceaccount.com

      - name: Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.REGISTRY_GAR }} --quiet

      # Use unique image names per run to avoid attestation pollution from previous runs
      - name: Create test image without SBOM
        run: |
          echo "FROM alpine:3.19" > /tmp/Dockerfile.test
          docker build -t ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }} -f /tmp/Dockerfile.test /tmp
          docker push ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }}
          DIGEST=$(docker manifest inspect ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }} -v | jq -r '.Descriptor.digest')
          echo "DIGEST=$DIGEST" >> $GITHUB_ENV

      - name: Attest Build Provenance only (no SBOM)
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.DIGEST }}

      - name: Test missing SBOM is detected
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          IMAGE="${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }}"

          echo "Test 1: Build Provenance should PASS..."
          if gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://slsa.dev/provenance/v1; then
            echo "âœ… Build Provenance PASSED (expected)"
          else
            echo "ERROR: Build Provenance should have passed!"
            exit 1
          fi

          echo ""
          echo "Test 2: SBOM should FAIL (not attached)..."
          if gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://spdx.dev/Document 2>&1; then
            echo "ERROR: SBOM should have failed!"
            exit 1
          else
            echo "âœ… SBOM correctly FAILED (expected)"
          fi

          echo ""
          echo "=========================================="
          echo "TEST 1 & 2 PASSED - Missing SBOM Detection"
          echo "=========================================="

      - name: Create test image with plain SBOM (no quality gates)
        run: |
          echo "FROM alpine:3.19" > /tmp/Dockerfile.plain
          docker build -t ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }} -f /tmp/Dockerfile.plain /tmp
          docker push ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }}
          PLAIN_DIGEST=$(docker manifest inspect ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }} -v | jq -r '.Descriptor.digest')
          echo "PLAIN_DIGEST=$PLAIN_DIGEST" >> $GITHUB_ENV

          # Create a minimal SBOM without quality gate annotations
          cat > /tmp/plain-sbom.spdx.json <<'EOF'
          {
            "spdxVersion": "SPDX-2.3",
            "dataLicense": "CC0-1.0",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "attestation-test-plain",
            "documentNamespace": "https://spdx.org/spdxdocs/attestation-test-plain",
            "creationInfo": {
              "created": "2025-12-02T00:00:00Z",
              "creators": ["Tool: syft-test"]
            },
            "packages": [{
              "SPDXID": "SPDXRef-Package-alpine",
              "name": "alpine",
              "versionInfo": "3.19",
              "downloadLocation": "NOASSERTION"
            }]
          }
          EOF

      - name: Attest plain SBOM (without quality gates)
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.PLAIN_DIGEST }}
          sbom-path: /tmp/plain-sbom.spdx.json

      - name: Attest Build Provenance for plain image
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-name: ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test
          subject-digest: ${{ env.PLAIN_DIGEST }}

      - name: Test missing quality gates are detected
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          IMAGE="${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }}"

          echo "=========================================="
          echo "Test 3: SBOM exists but lacks quality gates"
          echo "=========================================="
          echo ""

          echo "Test 3a: Build Provenance should PASS..."
          if gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://slsa.dev/provenance/v1; then
            echo "âœ… Build Provenance PASSED (expected)"
          else
            echo "ERROR: Build Provenance should have passed!"
            exit 1
          fi

          echo ""
          echo "Test 3b: SBOM attestation should PASS (it exists)..."
          SBOM_RESULT=$(gh attestation verify "oci://${IMAGE}" \
               --owner ${{ github.repository_owner }} \
               --predicate-type https://spdx.dev/Document \
               --format json 2>/dev/null || echo "[]")

          if [ "${SBOM_RESULT}" == "[]" ]; then
            echo "ERROR: SBOM should have passed!"
            exit 1
          else
            echo "âœ… SBOM attestation PASSED (expected)"
          fi

          echo ""
          echo "Test 3c: Quality gate extraction should return EMPTY..."
          # Extract quality gates using same logic as CD
          QUALITY_GATES=$(echo "${SBOM_RESULT}" | jq -r '
            .[0].verificationResult.statement.predicate.annotations[]? |
            select(.annotator == "Tool: baby-names-ci-pipeline") |
            .comment' 2>/dev/null || echo "")

          if [ -z "${QUALITY_GATES}" ]; then
            echo "âœ… Quality gates correctly EMPTY (expected)"
            echo ""
            echo "This image would be BLOCKED in strict enforcement mode"
            echo "because quality gate hashes are missing from SBOM."
          else
            echo "ERROR: Quality gates should be empty!"
            echo "Found: ${QUALITY_GATES}"
            exit 1
          fi

          echo ""
          echo "Test 3d: Simulating strict enforcement mode..."
          STRICT_MODE=true
          if [ "$STRICT_MODE" = "true" ] && [ -z "${QUALITY_GATES}" ]; then
            echo "âŒ DEPLOYMENT BLOCKED (strict mode)"
            echo ""
            echo "Reason: SBOM lacks quality gate annotations"
            echo "Required gates: lint, safety, coverage, trivy"
            echo ""
            echo "This demonstrates that strict enforcement would reject"
            echo "images built without proper quality gate verification."
          fi

          echo ""
          echo "=========================================="
          echo "TEST 3 PASSED - Missing Quality Gates Detection"
          echo ""
          echo "Verified supply chain enforcement:"
          echo "  âœ… SBOM exists â†’ attestation passes"
          echo "  âœ… Missing quality gates â†’ correctly detected"
          echo "  âœ… Strict mode â†’ would block deployment"
          echo "=========================================="

      - name: Cleanup test images
        if: always()
        run: |
          gcloud artifacts docker images delete \
            ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:no-sbom-${{ github.run_id }} \
            --quiet --delete-tags || true
          gcloud artifacts docker images delete \
            ${{ env.REGISTRY_GAR }}/${{ env.GAR_PROJECT_PRIMARY }}/${{ env.GAR_REPO }}/attestation-test:plain-sbom-${{ github.run_id }} \
            --quiet --delete-tags || true

  ##
  ## Integration Tests
  ##

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-scan-attest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install pytest requests

      - name: Start services with docker compose
        working-directory: examples/baby-names
        run: |
          docker compose up -d
          echo "Waiting for services to be ready..."
          sleep 30

      - name: Check service health
        run: |
          curl --retry 10 --retry-delay 5 --retry-connrefused http://localhost:5000/health
          curl --retry 10 --retry-delay 5 --retry-connrefused http://localhost:8080/health

      - name: Run integration tests
        working-directory: examples/baby-names
        env:
          BACKEND_URL: http://localhost:5000
          FRONTEND_URL: http://localhost:8080
        run: |
          pytest tests/integration/ -v

      - name: Show service logs on failure
        if: failure()
        working-directory: examples/baby-names
        run: |
          echo "=== Backend logs ==="
          docker compose logs backend
          echo "=== Frontend logs ==="
          docker compose logs frontend
          echo "=== Database logs ==="
          docker compose logs postgres

      - name: Cleanup
        if: always()
        working-directory: examples/baby-names
        run: docker compose down -v

  ##
  ## Summary Job
  ##

  ci-summary:
    name: CI Pipeline Summary
    runs-on: ubuntu-latest
    needs: [format-and-lint, dependency-security, unit-tests, build-scan-attest, attestation-verification-test, integration-tests]
    if: always()
    steps:
      - name: Generate Pipeline Summary
        run: |
          # Determine status icons
          FORMAT_ICON="${{ needs.format-and-lint.result == 'success' && 'âœ…' || 'âŒ' }}"
          SECURITY_ICON="${{ needs.dependency-security.result == 'success' && 'âœ…' || 'âŒ' }}"
          TEST_ICON="${{ needs.unit-tests.result == 'success' && 'âœ…' || 'âŒ' }}"
          BUILD_ICON="${{ needs.build-scan-attest.result == 'success' && 'âœ…' || 'âŒ' }}"
          INTEGRATION_ICON="${{ needs.integration-tests.result == 'success' && 'âœ…' || 'âŒ' }}"

          # Determine overall status
          if [ "${{ needs.format-and-lint.result }}" == "success" ] && \
             [ "${{ needs.dependency-security.result }}" == "success" ] && \
             [ "${{ needs.unit-tests.result }}" == "success" ] && \
             [ "${{ needs.build-scan-attest.result }}" == "success" ] && \
             [ "${{ needs.integration-tests.result }}" == "success" ]; then
            OVERALL_STATUS="âœ… **PASSED**"
            OVERALL_ICON="âœ…"
          else
            OVERALL_STATUS="âŒ **FAILED**"
            OVERALL_ICON="âŒ"
          fi

          # Generate Job Summary
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸš€ CI Pipeline Execution Summary

          ## Overall Status: $OVERALL_STATUS

          ---

          ## Phase A - Quality Gates (Sequential)

          | Job | Status | Result |
          |-----|--------|--------|
          | Format & Lint | $FORMAT_ICON | `${{ needs.format-and-lint.result }}` |
          | Dependency Security | $SECURITY_ICON | `${{ needs.dependency-security.result }}` |
          | Unit Tests | $TEST_ICON | `${{ needs.unit-tests.result }}` |

          ## Phase B - Build & Scan (Parallel)

          | Job | Status | Result |
          |-----|--------|--------|
          | Build/Scan/Attest | $BUILD_ICON | `${{ needs.build-scan-attest.result }}` |

          ## Phase C - Integration Tests

          | Job | Status | Result |
          |-----|--------|--------|
          | Integration Tests | $INTEGRATION_ICON | `${{ needs.integration-tests.result }}` |

          ---

          ## ðŸ“Š Pipeline Details

          - **Workflow**: `${{ github.workflow }}`
          - **Run Number**: `#${{ github.run_number }}`
          - **Triggered by**: `${{ github.event_name }}`
          - **Branch**: `${{ github.ref_name }}`
          - **Commit**: `${{ github.sha }}`
          - **Actor**: `@${{ github.actor }}`

          ## ðŸ”— Useful Links

          - [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          EOF

          # Replace variables in the summary
          sed -i "s|\$OVERALL_STATUS|$OVERALL_STATUS|g" $GITHUB_STEP_SUMMARY
          sed -i "s|\$FORMAT_ICON|$FORMAT_ICON|g" $GITHUB_STEP_SUMMARY
          sed -i "s|\$SECURITY_ICON|$SECURITY_ICON|g" $GITHUB_STEP_SUMMARY
          sed -i "s|\$TEST_ICON|$TEST_ICON|g" $GITHUB_STEP_SUMMARY
          sed -i "s|\$BUILD_ICON|$BUILD_ICON|g" $GITHUB_STEP_SUMMARY
          sed -i "s|\$INTEGRATION_ICON|$INTEGRATION_ICON|g" $GITHUB_STEP_SUMMARY

          # Exit with error if pipeline failed
          if [ "$OVERALL_ICON" == "âŒ" ]; then
            exit 1
          fi
