# Changelog

All notable changes to the Baby Names application will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- Terraform modules for GKE infrastructure (`terraform/modules/`)
  - `gcp-project-setup`: GCP APIs and Cloud NAT configuration
  - `gke-autopilot`: GKE Autopilot cluster provisioning
  - `gcp-service-account`: Service account with Workload Identity binding
  - `cloudsql`: CloudSQL PostgreSQL instance with IAM authentication
  - `k8s-namespace`: Kubernetes namespace, ServiceAccount, RBAC, and secrets
  - `database-bootstrap`: Database permissions setup via temporary pod
- Terraform environment configurations (`terraform/environments/`)
  - Staging and test environment configurations
  - Modular design with clear dependency chain
  - `helm_values_yaml` output for generating Helm values from Terraform
- Clear Terraform/Helm resource ownership separation
  - Terraform owns all prerequisite resources (Namespace, ServiceAccount, RBAC, Secrets)
  - Helm owns only application workloads (Deployments, Services, Job, Ingress)
  - Eliminates resource conflicts during deployment
- Migration job race condition fix
  - Added wait loop for Cloud SQL Proxy readiness before running Liquibase
  - Polls localhost:5432 up to 60 times (2s intervals) before proceeding
  - Prevents "connection refused" errors when proxy hasn't started yet
- Comprehensive three-phase CI pipeline with fail-fast quality gates
  - Phase A: Sequential quality checks (format, lint, security, tests)
  - Phase B: Parallel container build, scan, and attestation
  - Phase C: Integration tests with docker-compose deployment
- Container details output to GitHub Actions job summary
  - Each build job outputs registry URL and digest
  - Includes both short and full digest for easy verification
  - Links to attestation artifacts
- Integration tests integrated into CI pipeline
  - Moved from CD to CI workflow for earlier feedback
  - Tests full application stack with docker-compose
  - Includes service health checks before testing
  - Comprehensive logging on failure
- Helm chart for Kubernetes deployment (`helm/baby-names/`)
  - Separate templates for namespace, serviceaccount, deployments, services, ingress
  - Cloud SQL Proxy sidecar for IAM database authentication
  - Helm hooks for pre-install/pre-upgrade database migrations
  - Environment-specific values files (values.yaml, values-staging.yaml)
  - Support for both IAM and password-based authentication
- GKE deployment via CD workflow
  - Direct Workload Identity Federation (WIF) for GitHub Actions authentication
  - Helm-based deployment to GKE cluster
  - Automated database migrations via Helm hooks
  - Health verification after deployment
- Smoke tests for deployed staging environment
  - Frontend and backend health endpoint verification
  - Database connectivity validation
  - Critical user path testing (name lookup)
- IAM database authentication support
  - Backend modified to support passwordless IAM authentication
  - Cloud SQL Proxy sidecar handles IAM token generation
  - Maintains backward compatibility with password-based auth
  - Liquibase migrations support IAM authentication
- GKE infrastructure requirements for private clusters
  - Cloud NAT configuration for egress traffic to external registries
  - Cloud SQL Admin API enablement for IAM authentication
  - Workload Identity binding between Kubernetes and GCP service accounts
  - IAM database user creation in CloudSQL
- ImagePullSecret configuration for private container registries
  - Kubernetes secret for GitHub Container Registry authentication
  - Service account patching with imagePullSecrets
  - Support for read:packages scoped GitHub personal access tokens
- Makefile-based build system for local and CI execution
  - Root Makefile for orchestrating multi-component builds
  - Component-level Makefiles (backend, frontend, database)
  - Support for Phase A (`make phase-a`) and Phase B (`make phase-b`) execution
- Code quality tooling
  - Ruff 0.8.4 for Python linting and formatting
  - Configured with project-specific rules in `ruff.toml`
- Security scanning infrastructure
  - Safety 2.3.5 for Python dependency vulnerability scanning
  - `.safety-policy.yml` for CRITICAL-only filtering in CI
  - Syft for SBOM generation (SPDX format)
  - Trivy for container vulnerability scanning
- Supply chain security with GitHub Actions attestations
  - Lint results attestation
  - Security scan results attestation
  - Test coverage attestation
  - Container SBOM attestation
  - Container vulnerability scan attestation
  - Build provenance attestation
- Test infrastructure improvements
  - Backend test fixtures with database connection mocking (`tests/conftest.py`)
  - 93% code coverage for backend (14 tests)
  - 99% code coverage for frontend (7 tests)
  - All tests runnable without live database connection

### Changed
- **BREAKING**: Removed overlapping Helm templates in favor of Terraform
  - Deleted `helm/baby-names/templates/namespace.yaml` (Terraform creates namespace)
  - Deleted `helm/baby-names/templates/serviceaccount.yaml` (Terraform creates SA with Workload Identity)
  - Removed `namespace.create` and `serviceAccount.create` flags from values.yaml
  - Helm now references Terraform-created resources by name only
- **BREAKING**: Migrated from Debian to Alpine Linux base images
  - Backend: `python:3.11-alpine` (from `python:3.11-slim`)
  - Frontend: `python:3.11-alpine` (from `python:3.11-slim`)
  - Eliminates 3 CRITICAL CVEs present in Debian base images
  - Zero CRITICAL vulnerabilities in Alpine-based containers
- Updated Python dependencies
  - Flask 3.0.0 → 3.1.0
  - flask-cors 4.0.0 → 6.0.0
  - requests 2.31.0 → 2.32.4
- Replaced Flake8 and Black with Ruff for unified linting/formatting
- GitHub Actions CI workflow now delegates to Makefiles
  - Consistent behavior between local and CI environments
  - Single source of truth for build/test/scan commands
- CD workflow now performs actual GKE deployment
  - Uses Direct Workload Identity Federation instead of service account keys
  - Deploys to manually provisioned GKE cluster and CloudSQL instance
  - Integration tests moved to CI pipeline for earlier feedback
  - Smoke tests verify deployed application health
  - Clearer separation: CI validates, CD deploys
- Database connection handling in backend
  - Fixed psycopg2.pool import for proper connection pooling
  - Uses `from psycopg2 import pool` instead of `psycopg2.pool`
  - Added IAM authentication support via `DB_IAM_AUTH` environment variable
  - Conditionally omits password when IAM auth is enabled
- Frontend error handling
  - Test suite now uses `requests.exceptions.ConnectionError` instead of generic Exception

### Fixed
- Unit tests no longer require running PostgreSQL instance
- Import sorting issues detected by Ruff
- Module-level database instantiation now properly mocked during tests
- Configuration files (`.safety-policy.yml`, `ruff.toml`) moved to correct location under `examples/baby-names/`
- Helm deployment ordering issue where migration job couldn't find service account
  - Removed Helm hooks from migration job to allow regular resource creation order
  - Added init containers to backend/frontend to wait for migration completion
  - Ensures service account exists before migration job attempts to use it
- Container image paths in Helm values.yaml missing repository path component
  - Fixed backend image path: `ghcr.io/db-hackathon/hello-world/baby-names-backend`
  - Fixed frontend image path: `ghcr.io/db-hackathon/hello-world/baby-names-frontend`
  - Fixed migration image path: `ghcr.io/db-hackathon/hello-world/baby-names-db-migration`
  - Aligns with CI workflow image naming convention using `${{ github.repository }}`
- Helm deployment failure due to namespace creation ordering issues
  - Disabled namespace template creation in staging environment (`namespace.create: false`)
  - Re-enabled `--create-namespace` flag in CD workflow for namespace creation
  - Prevents "namespace not found" errors when Helm tries to create resources before namespace exists
  - Avoids "namespace already exists" conflict between Helm flag and template
- Private GKE cluster network connectivity for external container registries
  - Created Cloud Router (`nat-router`) in `europe-west1` region
  - Configured Cloud NAT (`nat-config`) for all subnet IP ranges with auto-allocated external IPs
  - Enables private cluster nodes to pull images from ghcr.io and other external registries
- Container image authentication to GitHub Container Registry
  - Created Kubernetes docker-registry secret (`ghcr-secret`) with read:packages scoped token
  - Patched service account with imagePullSecrets for automatic credential injection
  - Resolved 401 Unauthorized and 403 Forbidden errors when pulling private images
- CI workflow image tagging for GKE deployments
  - CD workflow now uses `main` tag instead of SHA-based tags
  - Aligns with CI workflow's metadata-action tag strategy (`type=ref,event=branch`)
  - Resolved "image not found" errors during Helm deployments
- Cloud SQL Proxy IAM authentication configuration
  - Added `roles/cloudsql.client` to GCP service account for Cloud SQL Proxy access
  - Created Workload Identity binding: `serviceAccount:extended-ascent-477308-m8.svc.id.goog[baby-names-staging/baby-names-staging]`
  - Enabled Cloud SQL Admin API (`sqladmin.googleapis.com`) in project
  - Created IAM database user `hello-world-staging@extended-ascent-477308-m8.iam` in CloudSQL instance
- CloudSQL instance IAM authentication enablement
  - Enabled `cloudsql.iam_authentication=on` database flag on CloudSQL instance
  - Required prerequisite for IAM-based database authentication to function
  - Instance restart required for flag to take effect
- PostgreSQL database permissions for IAM service account
  - Manually created `baby_names` database via postgres user
  - Granted ALL PRIVILEGES on database and public schema to IAM service account
  - Granted CREATE permission on public schema for migration table creation
  - Configured default privileges for future tables and sequences
- RBAC permissions for init containers
  - Created Role `migration-watcher` with get/list/watch permissions for pods and jobs
  - Created RoleBinding linking role to `baby-names-staging` service account
  - Enables init containers to query migration pod status
- Init container migration completion detection
  - Updated init containers to check migration pod completion instead of job completion
  - Works around Kubernetes Jobs with sidecars limitation (cloud-sql-proxy never exits)
  - Checks for migration container exit code 0 instead of job condition=complete
  - Added fallback timeout to proceed if migration pod not found (database already migrated)
- GKE Autopilot deployment timing issues
  - Increased Terraform bootstrap timeout from 300s to 600s for node scaling
  - Increased Helm deployment timeout from 10m to 15m for rate limiting resilience
  - GKE Autopilot nodes scale on-demand, requiring longer initial deployment timeouts
- Enhanced CD verification step
  - Added `kubectl rollout status` checks for deployments
  - Added pod health validation (fails if pods not Running/Succeeded)
  - Added ingress IP assignment wait loop (up to 5 minutes)
  - Provides clear status output for debugging deployment issues
- DB_PASSWORD environment variable not passed to backend container
  - Added conditional DB_PASSWORD handling in `backend-deployment.yaml`
  - Matches existing pattern in `migration-job.yaml`
  - Uses `toString` for type-safe comparison with DB_IAM_AUTH
  - Enables password-based authentication for non-IAM deployments

### Security
- Container images now scan clean for CRITICAL vulnerabilities
- Dependency vulnerability scanning integrated into CI pipeline
- All security artifacts attested via GitHub Actions
- SBOM generated for all containers (backend, frontend, db-migration)
- IAM-based authentication for database access (no passwords in production)
  - Uses Google Cloud IAM for CloudSQL authentication
  - Cloud SQL Proxy handles automatic token refresh
  - GKE Workload Identity links Kubernetes service accounts to GCP service accounts
- Direct Workload Identity Federation for GitHub Actions
  - No long-lived service account keys required
  - GitHub OIDC tokens provide short-lived access to GCP
  - Principle of least privilege via precise IAM bindings
